# 短褲分配邏輯說明

## 🎯 系統概述

全新的短褲分配系統採用**腰圍群組分配法**，結合**雙層排序**與**智慧褲長調整**機制，確保每位學生都能獲得最適合的短褲尺碼。

---

## 📏 腰圍群組劃分

系統將所有學生按腰圍分為10個群組，每個群組對應特定的短褲尺碼：

| 群組 | 腰圍範圍 | 對應尺碼 | 備註 |
|------|----------|----------|------|
| 群組1 | ≤22 | XS/34 | 最小尺碼群組 |
| 群組2 | 22 < 腰圍 ≤ 25 | S/36 | |
| 群組3 | 25 < 腰圍 ≤ 28 | M/38 | |
| 群組4 | 28 < 腰圍 ≤ 31 | L/40 | |
| 群組5 | 31 < 腰圍 ≤ 34 | XL/42 | |
| 群組6 | 34 < 腰圍 ≤ 37 | 2L/44 | |
| 群組7 | 37 < 腰圍 ≤ 39 | 3L/46 | |
| 群組8 | 39 < 腰圍 ≤ 41 | 4L/48 | |
| 群組9 | 41 < 腰圍 ≤ 44 | 5L/50 & 6L/52 | 多尺碼選擇 |
| 群組10 | 44 < 腰圍 ≤ 47 | 7L/54 & 8L/56 | 多尺碼選擇 |

### 🔹 多尺碼群組規則
- **群組9和群組10**有兩個尺碼選項
- **優先選擇較小尺碼**（如5L/50優先於6L/52）
- 小尺碼庫存不足時，自動選擇大尺碼

---

## 🔄 雙層排序機制

在每個群組內，學生按以下順序排列：

### 第一層排序：腰圍優先
- 腰圍較小的學生優先分配
- 確保基本尺碼需求得到滿足

### 第二層排序：褲長次序
- **同腰圍的學生中，褲長較短的優先分配**
- 讓褲長較長的學生有更多機會透過褲長調整獲得合適尺碼

### 📋 排序實例
```
群組4學生排序範例：
1. 王小明 (腰圍29, 褲長35) ← 優先
2. 李小華 (腰圍29, 褲長40)
3. 張小美 (腰圍30, 褲長32)
4. 陳小強 (腰圍30, 褲長45) ← 最後
```

---

## 🎲 分配流程

### 步驟1：學生分組
- 根據腰圍將學生分配到對應群組
- 腰圍超出範圍的學生標記為分配失敗

### 步驟2：群組內排序
- 每個群組內執行雙層排序
- 產生最終的分配順序

### 步驟3：逐群組分配
- 從群組1開始，按順序處理每個群組
- 處理轉移學生的優先分配權

### 步驟4：個別學生處理
對每個學生執行以下步驟：
1. **尺碼選擇**：根據群組對應表選擇基本尺碼
2. **庫存檢查**：確認是否有足夠庫存
3. **褲長監聽**：執行褲長調整判定
4. **最終分配**：扣減庫存並記錄結果

---

## 👕 褲長監聽器機制

褲長監聽器會自動檢測學生的褲長需求，並進行尺碼調整：

### 🔍 判定標準
```
褲長差值 = 學生褲長 - 分配尺碼的數值
```

### 📈 調整規則

| 褲長差值範圍 | 調整動作 | 顯示標記 | 說明 |
|-------------|----------|----------|------|
| < 1 | 無需調整 | - | 尺碼適合 |
| 1 ≤ 差值 < 3 | 升級1個尺碼 | ↑ | 提升一號 |
| 差值 ≥ 3 | 升級2個尺碼 | ↑2 | 提升兩號 |

### 🚫 調整失敗處理
- **升級失敗**：庫存不足時，標記為分配失敗
- **無更大尺碼**：分配當前可得的最大尺碼，標記為 `↑MAX`

### 💡 實際範例
```
學生A：分配到L/40，褲長42
褲長差值 = 42 - 40 = 2 (在1-3範圍內)
→ 升級到XL/42，標記↑

學生B：分配到M/38，褲長42  
褲長差值 = 42 - 38 = 4 (≥3)
→ 升級2個尺碼到XL/42，標記↑2
```

---

## 🔄 群組轉移機制

當群組內庫存不足時，啟動轉移機制：

### 轉移條件
- 學生無法在原群組獲得分配
- 目標群組不是最後一個群組（群組10）

### 轉移規則
1. **只有原群組學生可以轉移**（轉移來的學生無法再次轉移）
2. **轉移學生獲得下一群組的優先分配權**
3. **每個學生最多轉移一次**

### 優先順序
```
群組N的分配順序：
1. 從群組N-1轉移來的學生 (最高優先權)
2. 群組N的原有學生 (按雙層排序)
```

### 📊 轉移流程圖
```
群組1 → 群組2 → 群組3 → ... → 群組10
  ↓      ↓        ↓              ↓
庫存不足  優先分配  繼續轉移      分配失敗
  ↓      ↓        ↓              (無法轉移)
轉移     成功      轉移
```

---

## ⚠️ 特殊情況處理

### 1. 腰圍超出範圍
- **情況**：學生腰圍 > 47 或 ≤ 0
- **處理**：標記為分配失敗，原因：「腰圍超出範圍」

### 2. 學生不需要短褲
- **情況**：`shortSleevePantsCount` = 0
- **處理**：跳過分配，不計入統計

### 3. 全有或全無原則
- **情況**：學生需要多件短褲但庫存不足
- **處理**：完全不分配，將學生轉移到下一群組

### 4. 最後群組無法轉移
- **情況**：群組10的學生分配失敗
- **處理**：標記為分配失敗，原因：「庫存不足（最後群組）」

### 5. 庫存扣減異常
- **情況**：`decreaseInventory` 函數返回失敗
- **處理**：標記為分配失敗，原因：「庫存扣減異常」

---

## 📊 統計與日誌

### 分配統計
系統會追蹤以下數據：

| 統計項目 | 說明 |
|---------|------|
| `allocated` | 成功分配的學生數 |
| `failed` | 分配失敗的學生數 |
| `pantsSizeAdjusted` | 褲長調整↑的次數 |
| `pantsSizeDoubleAdjusted` | 褲長調整↑2的次數 |
| `transferredStudents` | 群組轉移的總人次 |

### 群組統計
每個群組會記錄：
- `originalCount`：原群組學生數
- `transferredInCount`：轉移進入的學生數
- `total`：總處理學生數
- `allocated`：成功分配數
- `failed`：分配失敗數
- `transferredToNext`：轉移到下一群組的學生

### 📝 日誌輸出
系統提供詳細的日誌資訊：

1. **初始狀態**：庫存情況、學生分組結果
2. **分配過程**：每個學生的分配判斷與結果
3. **群組統計**：各群組的分配成果
4. **最終總結**：整體統計與剩餘庫存

---

## ✅ 系統優勢

1. **精確匹配**：每個腰圍範圍對應適合的尺碼，避免不當分配
2. **公平排序**：雙層排序確保合理的分配優先權
3. **智慧調整**：褲長監聽器自動處理尺碼升級需求
4. **彈性轉移**：群組轉移機制提供第二次分配機會
5. **全面追蹤**：完整記錄每個決策過程和分配結果
6. **防呆設計**：各種異常情況都有明確的處理邏輯

---

## 📋 使用建議

1. **庫存準備**：確保各尺碼庫存充足，特別是中間尺碼（L/40、XL/42）
2. **數據檢查**：分配前確認學生的腰圍和褲長數據準確
3. **結果分析**：分配後檢視統計報告，了解各群組的分配情況
4. **異常處理**：對分配失敗的學生進行個別處理

---

*此分配邏輯適用於短褲分配，長褲分配邏輯可能略有不同。* 